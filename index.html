<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaVerse AI æœç´¢åŸå‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #a0a0a0;
            font-size: 14px;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .input-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #userInput {
            flex: 1;
            padding: 15px 20px;
            padding-right: 60px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            outline: none;
            transition: all 0.3s;
        }

        #userInput:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.12);
        }

        #userInput::placeholder {
            color: #777;
        }

        .send-btn {
            position: absolute;
            right: 8px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .clear-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .history-section {
            margin-top: 30px;
        }

        .history-section h3 {
            font-size: 16px;
            color: #a0a0a0;
            margin-bottom: 15px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .history-item .status {
            font-size: 18px;
        }

        .result-section {
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .thinking-box {
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            margin: 20px 0;
            text-align: center;
        }

        .thinking-box .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .decision-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .decision-panel h3 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .decision-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .decision-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .decision-section h4 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .decision-section p {
            color: #c0c0c0;
            line-height: 1.6;
            font-size: 14px;
        }

        .skill-tag {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            font-size: 13px;
            margin: 5px 5px 5px 0;
        }

        .result-image {
            width: 100%;
            height: 400px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-image-placeholder {
            color: #666;
            font-size: 14px;
        }

        .feedback-section {
            margin-top: 20px;
        }

        .feedback-section h4 {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-feedback {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-feedback:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
        }

        .discover-section {
            margin-top: 20px;
        }

        .discover-title {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .discover-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .discover-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .discover-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .discover-card-image {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .discover-card-content {
            padding: 15px;
        }

        .discover-card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #fff;
        }

        .discover-card-desc {
            font-size: 12px;
            color: #999;
            line-height: 1.4;
        }

        .toggle-details {
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .toggle-details:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }

        .multi-skill-result {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .skill-result-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .skill-result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .skill-result-header h4 {
            font-size: 16px;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            .main-card {
                padding: 20px;
            }

            .discover-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŠ SeaVerse AI æœç´¢åŸå‹</h1>
            <p>åŸºäºç”¨æˆ·å†å²çš„æ™ºèƒ½æŠ€èƒ½åŒ¹é…ç³»ç»Ÿ</p>
        </div>

        <div class="main-card">
            <div class="input-section">
                <h2>ğŸ’¬ å‘Šè¯‰æˆ‘ä½ æƒ³åšä»€ä¹ˆ</h2>
                <div class="input-wrapper">
                    <input type="text" id="userInput" placeholder="ä¾‹å¦‚ï¼šç”»ä¸€åªå¯çˆ±çš„çŒ«å’ªã€ç”Ÿæˆäº§å“ä»‹ç»è§†é¢‘ã€åˆ¶ä½œéŸ³ä¹..." />
                    <button class="send-btn" onclick="handleGenerate()">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                    <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
                </div>
            </div>

            <div class="history-section">
                <h3>ğŸ“œ å†å²è®°å½• (<span id="historyCount">0</span> æ¬¡)</h3>
                <div class="history-list" id="historyList">
                    <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                        æš‚æ— å†å²è®°å½•
                    </div>
                </div>
            </div>
        </div>

        <div class="main-card result-section" id="resultSection">
            <div class="thinking-box" id="thinkingBox">
                <div class="spinner"></div>
                <p>ğŸ¤– AI æ­£åœ¨ä¸ºä½ ç”Ÿæˆ...</p>
                <p style="font-size: 12px; color: #999; margin-top: 5px;">é¢„è®¡ <span id="estimatedTime">10</span> ç§’å®Œæˆ</p>
                <p class="toggle-details" onclick="toggleDetails()">ğŸ” æŸ¥çœ‹è¯¦æƒ…</p>
            </div>

            <div class="decision-panel hidden" id="decisionPanel">
                <h3>ğŸ” AI å†³ç­–è¿‡ç¨‹</h3>
                <div id="decisionContent"></div>
            </div>

            <div class="hidden" id="resultContent">
                <div id="multiSkillResults" class="multi-skill-result"></div>

                <div class="feedback-section">
                    <h4>ğŸ’¬ ç»“æœæ»¡æ„å—ï¼Ÿ</h4>
                    <div class="feedback-buttons">
                        <button class="btn-feedback" onclick="giveFeedback('satisfied')">ğŸ˜Š å¾ˆæ»¡æ„</button>
                        <button class="btn-feedback" onclick="giveFeedback('retry')">ğŸ˜ æ¢ä¸€ä¸ª</button>
                        <button class="btn-feedback" onclick="giveFeedback('adjust')">ğŸ”§ æˆ‘è¦è°ƒæ•´</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-card discover-section hidden" id="discoverSection">
            <div class="discover-title">
                <span>âœ¨</span>
                <span>Discover more</span>
            </div>
            <p style="color: #999; font-size: 14px; margin-bottom: 15px;" id="discoverMessage"></p>
            <div class="discover-cards" id="discoverCards"></div>
        </div>
    </div>

    <script>
        const skills = [
            {
                id: "api_volces_seedream_4_5",
                name: "Seedream 4.5",
                display_name: "Image - Seedream 4.5",
                type: "image",
                tags: ["image", "cute", "chinese", "fast"],
                bestFor: "å¯çˆ±é£æ ¼ã€ä¸­æ–‡ç†è§£ã€å¿«é€Ÿç”Ÿæˆ",
                promptStyle: "è¯¦ç»†ä¸­æ–‡æè¿° + é£æ ¼å…³é”®è¯",
                example: "ä¸€åªå¯çˆ±çš„æ©˜è‰²å°çŒ«å’ªï¼Œæ¯›èŒ¸èŒ¸çš„ï¼Œå¤§çœ¼ç›..."
            },
            {
                id: "api_google_gemini3_pro_image",
                name: "Gemini 3 Pro",
                display_name: "Image - Gemini 3 Pro",
                type: "image",
                tags: ["image", "professional", "realistic", "quality"],
                bestFor: "å†™å®é£æ ¼ã€ä¸“ä¸šæ‘„å½±ã€æœ€é«˜è´¨é‡",
                promptStyle: "è‹±æ–‡ä¸“ä¸šæœ¯è¯­ + æ‘„å½±å‚æ•°",
                example: "professional cat portrait, studio lighting..."
            },
            {
                id: "api_kling_v2_6",
                name: "Kling v2.6",
                display_name: "Video - Kling v2.6",
                type: "video",
                tags: ["video", "audio", "professional", "sync"],
                bestFor: "éŸ³è§†é¢‘åŒæ­¥ã€ä¸“ä¸šçº§è´¨é‡ã€äº§å“ä»‹ç»",
                promptStyle: "è¯¦ç»†åœºæ™¯æè¿° + è¿é•œè¦æ±‚",
                example: "äº§å“åœ¨é˜³å…‰ä¸‹å±•ç¤ºï¼Œæ…¢é•œå¤´ç‰¹å†™..."
            },
            {
                id: "api_alibaba_wanx25_t2v_preview",
                name: "Wanx 2.5",
                display_name: "Video - Wanx 2.5",
                type: "video",
                tags: ["video", "fast", "economical"],
                bestFor: "å¿«é€Ÿç”Ÿæˆã€æ€§ä»·æ¯”é«˜ã€æ¦‚å¿µéªŒè¯",
                promptStyle: "ç®€æ´åœºæ™¯æè¿°",
                example: "ä¸€åªçŒ«åœ¨èŠ±å›­é‡Œç©è€"
            },
            {
                id: "api_mureka_song_generator",
                name: "Mureka Song",
                display_name: "Audio - Mureka Song",
                type: "audio",
                tags: ["audio", "music", "song"],
                bestFor: "å®Œæ•´æ­Œæ›²ç”Ÿæˆã€å¤šç§é£æ ¼",
                promptStyle: "é£æ ¼ + æƒ…æ„Ÿ + ä¸»é¢˜",
                example: "è½»å¿«çš„æµè¡Œæ­Œæ›²ï¼Œå…³äºå¤å¤©"
            }
        ];

        let userHistory = [];
        let currentSession = null;

        function init() {
            loadHistory();
            updateHistoryDisplay();
        }

        async function handleGenerate() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥ä½ çš„éœ€æ±‚');
                return;
            }

            document.getElementById('resultSection').classList.add('active');
            document.getElementById('thinkingBox').classList.remove('hidden');
            document.getElementById('decisionPanel').classList.add('hidden');
            document.getElementById('resultContent').classList.add('hidden');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            try {
                const decision = aiDecision(input, userHistory);
                displayDecision(decision);
                simulateThinkingAnimation();
                const results = await realGeneration(decision);
                displayRealResult(decision, results);
                saveToHistory(input, decision);
                checkDiscoverRecommendation();
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                document.getElementById('thinkingBox').classList.add('hidden');
                alert(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`);
            }
        }

        function simulateThinkingAnimation() {
            let time = 10;
            const timer = setInterval(() => {
                time--;
                const timeElement = document.getElementById('estimatedTime');
                if (timeElement) {
                    timeElement.textContent = time;
                }
                if (time <= 0) {
                    clearInterval(timer);
                }
            }, 500);
        }

        async function realGeneration(decision) {
            const results = [];
            for (const skill of decision.skills) {
                const prompt = decision.optimizedPrompts[decision.skills.indexOf(skill)];
                try {
                    let result;
                    if (skill.type === 'image') {
                        result = await callImageSkill(skill.id, prompt);
                    } else if (skill.type === 'video') {
                        result = await callVideoSkill(skill.id, prompt);
                    } else if (skill.type === 'audio') {
                        result = await callAudioSkill(skill.id, prompt);
                    }
                    results.push({ skill: skill, success: true, data: result });
                } catch (error) {
                    results.push({ skill: skill, success: false, error: error.message });
                }
            }
            return results;
        }

        async function callImageSkill(skillId, prompt) {
            const response = await fetch('/api/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ skillId: skillId, prompt: prompt })
            });
            if (!response.ok) throw new Error('å›¾åƒç”Ÿæˆå¤±è´¥');
            return await response.json();
        }

        async function callVideoSkill(skillId, prompt) {
            const response = await fetch('/api/generate-video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ skillId: skillId, prompt: prompt })
            });
            if (!response.ok) throw new Error('è§†é¢‘ç”Ÿæˆå¤±è´¥');
            return await response.json();
        }

        async function callAudioSkill(skillId, prompt) {
            const response = await fetch('/api/generate-audio', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ skillId: skillId, prompt: prompt })
            });
            if (!response.ok) throw new Error('éŸ³é¢‘ç”Ÿæˆå¤±è´¥');
            return await response.json();
        }

        function displayRealResult(decision, results) {
            document.getElementById('thinkingBox').classList.add('hidden');
            document.getElementById('resultContent').classList.remove('hidden');

            const multiResults = results.map((result, index) => {
                const skill = result.skill;
                let mediaHtml = '';

                if (result.success) {
                    if (skill.type === 'image' && result.data.imageUrl) {
                        mediaHtml = `<div class="result-image"><img src="${result.data.imageUrl}" alt="ç”Ÿæˆçš„å›¾åƒ" /></div>`;
                    } else if (skill.type === 'video' && result.data.videoUrl) {
                        mediaHtml = `<div class="result-image"><video src="${result.data.videoUrl}" controls style="width: 100%; height: 100%; object-fit: cover;"></video></div>`;
                    } else if (skill.type === 'audio' && result.data.audioUrl) {
                        mediaHtml = `<div style="padding: 20px;"><audio src="${result.data.audioUrl}" controls style="width: 100%;"></audio></div>`;
                    } else {
                        mediaHtml = '<div class="result-image"><div class="result-image-placeholder">ç”Ÿæˆä¸­...</div></div>';
                    }
                } else {
                    mediaHtml = `<div class="result-image"><div class="result-image-placeholder" style="color: #ff6b6b;">âŒ ${result.error}</div></div>`;
                }

                return `
                    <div class="skill-result-item">
                        <div class="skill-result-header">
                            <h4>ğŸ¨ ${skill.display_name}</h4>
                            <span style="color: ${result.success ? '#51cf66' : '#ff6b6b'}; font-size: 12px;">${result.success ? 'âœ… ç”ŸæˆæˆåŠŸ' : 'âŒ ç”Ÿæˆå¤±è´¥'}</span>
                        </div>
                        ${mediaHtml}
                        <p style="font-size: 13px; color: #999; margin-top: 10px;">ä½¿ç”¨çš„ Prompt: ${decision.optimizedPrompts[index]}</p>
                    </div>
                `;
            }).join('');

            document.getElementById('multiSkillResults').innerHTML = multiResults;
        }


        function aiDecision(input, history) {
            const lowerInput = input.toLowerCase();
            const preference = analyzePreference(history);
            let selectedSkills = [];
            let reason = "";

            if (lowerInput.includes('ä»‹ç»è§†é¢‘') || lowerInput.includes('å®£ä¼ ç‰‡') || (lowerInput.includes('è§†é¢‘') && lowerInput.includes('éŸ³ä¹'))) {
                selectedSkills = [skills.find(s => s.id === 'api_kling_v2_6'), skills.find(s => s.id === 'api_mureka_song')];
                reason = "æ£€æµ‹åˆ°ä½ éœ€è¦å®Œæ•´çš„è§†é¢‘åˆ¶ä½œæµç¨‹ï¼Œæˆ‘ä¸ºä½ ç»„åˆäº†è§†é¢‘ç”Ÿæˆå’ŒéŸ³ä¹åˆ›ä½œä¸¤ä¸ªæŠ€èƒ½";
            }
            else if (lowerInput.includes('ç”»') || lowerInput.includes('å›¾') || lowerInput.includes('ç…§ç‰‡') || lowerInput.includes('çŒ«') || lowerInput.includes('ç‹—')) {
                if (preference.style === 'cute') {
                    selectedSkills = [skills.find(s => s.id === 'api_volces_seedream_4_5')];
                    reason = `åŸºäºä½ çš„å†å²åå¥½ï¼ˆ${preference.cuteCount}æ¬¡å¯çˆ±é£æ ¼ï¼‰ï¼Œé€‰æ‹© Seedream 4.5`;
                } else if (preference.style === 'professional') {
                    selectedSkills = [skills.find(s => s.id === 'api_google_gemini3_pro_image')];
                    reason = `åŸºäºä½ çš„å†å²åå¥½ï¼ˆ${preference.professionalCount}æ¬¡ä¸“ä¸šé£æ ¼ï¼‰ï¼Œé€‰æ‹© Gemini 3 Pro`;
                } else {
                    selectedSkills = [skills.find(s => s.id === 'api_volces_seedream_4_5')];
                    reason = "é¦–æ¬¡ä½¿ç”¨ï¼Œæ¨èä¸­æ–‡å‹å¥½çš„ Seedream 4.5";
                }
            }
            else if (lowerInput.includes('è§†é¢‘')) {
                selectedSkills = [skills.find(s => s.id === 'api_kling_v2_6')];
                reason = "ä¸“ä¸šè§†é¢‘ç”Ÿæˆéœ€æ±‚ï¼Œé€‰æ‹© Kling v2.6";
            }
            else if (lowerInput.includes('éŸ³ä¹') || lowerInput.includes('æ­Œ')) {
                selectedSkills = [skills.find(s => s.id === 'api_mureka_song_generator')];
                reason = "éŸ³ä¹åˆ›ä½œéœ€æ±‚ï¼Œé€‰æ‹© Mureka Song";
            }
            else {
                selectedSkills = [skills.find(s => s.id === 'api_volces_seedream_4_5')];
                reason = "é€šç”¨éœ€æ±‚ï¼Œé€‰æ‹© Seedream 4.5";
            }

            const optimizedPrompts = selectedSkills.map(skill => optimizePrompt(input, skill, preference));
            return {
                input: input,
                understanding: analyzeIntent(input, preference),
                skills: selectedSkills,
                reason: reason,
                optimizedPrompts: optimizedPrompts,
                params: inferParams(preference)
            };
        }

        function analyzePreference(history) {
            if (history.length === 0) {
                return { style: 'unknown', cuteCount: 0, professionalCount: 0 };
            }
            let cuteCount = 0;
            let professionalCount = 0;
            history.forEach(item => {
                if (item.style === 'cute') cuteCount++;
                if (item.style === 'professional') professionalCount++;
            });
            return {
                style: cuteCount > professionalCount ? 'cute' : (professionalCount > 0 ? 'professional' : 'unknown'),
                cuteCount: cuteCount,
                professionalCount: professionalCount
            };
        }

        function analyzeIntent(input, preference) {
            const lowerInput = input.toLowerCase();
            let intent = "ç”Ÿæˆå†…å®¹";
            if (lowerInput.includes('ç”»') || lowerInput.includes('å›¾')) {
                intent = "ç”Ÿæˆå›¾åƒ";
            } else if (lowerInput.includes('è§†é¢‘')) {
                intent = "ç”Ÿæˆè§†é¢‘";
            } else if (lowerInput.includes('éŸ³ä¹') || lowerInput.includes('æ­Œ')) {
                intent = "ç”ŸæˆéŸ³ä¹";
            }
            let styleGuess = "é£æ ¼æœªçŸ¥";
            if (preference.style === 'cute') {
                styleGuess = `å¯çˆ±é£æ ¼ï¼ˆåŸºäºä½ ä¹‹å‰${preference.cuteCount}æ¬¡åå¥½ï¼‰`;
            } else if (preference.style === 'professional') {
                styleGuess = `ä¸“ä¸šé£æ ¼ï¼ˆåŸºäºä½ ä¹‹å‰${preference.professionalCount}æ¬¡åå¥½ï¼‰`;
            } else if (lowerInput.includes('å¯çˆ±') || lowerInput.includes('èŒ')) {
                styleGuess = "å¯çˆ±é£æ ¼";
            } else if (lowerInput.includes('ä¸“ä¸š') || lowerInput.includes('å•†ä¸š')) {
                styleGuess = "ä¸“ä¸šé£æ ¼";
            }
            return `${intent}ï¼Œ${styleGuess}`;
        }

        function optimizePrompt(input, skill, preference) {
            if (skill.type === 'image') {
                if (skill.id === 'api_volces_seedream_4_5') {
                    return `${input}ï¼Œæ¯›èŒ¸èŒ¸çš„ï¼Œå¤§çœ¼ç›ï¼Œæ¸©æš–çš„å…‰çº¿ï¼Œé«˜æ¸…ç»†èŠ‚ï¼Œæ²»æ„ˆç³»æ’ç”»é£æ ¼`;
                } else if (skill.id === 'api_google_gemini3_pro_image') {
                    return `professional ${input}, studio lighting, high quality, 8k resolution, commercial photography`;
                }
            } else if (skill.type === 'video') {
                return `${input}ï¼Œé•œå¤´å¹³ç¨³ç§»åŠ¨ï¼Œè‡ªç„¶å…‰çº¿ï¼Œé«˜æ¸…ç”»è´¨`;
            } else if (skill.type === 'audio') {
                return `${input}ï¼Œæµè¡Œé£æ ¼ï¼Œè½»å¿«èŠ‚å¥`;
            }
            return input;
        }

        function inferParams(preference) {
            return { resolution: "1024x1024", duration: "10ç§’", quality: "high" };
        }

        function displayDecision(decision) {
            const content = `
                <div class="decision-section">
                    <h4>ğŸ“Š æˆ‘çš„ç†è§£</h4>
                    <p>${decision.understanding}</p>
                </div>
                <div class="decision-section">
                    <h4>ğŸ¯ æŠ€èƒ½é€‰æ‹© (${decision.skills.length}ä¸ª)</h4>
                    <p style="margin-bottom: 10px;">${decision.reason}</p>
                    ${decision.skills.map((skill, index) => `
                        <div style="margin: 10px 0;">
                            <span class="skill-tag">âœ… ${skill.display_name}</span>
                            <p style="margin-top: 5px; font-size: 13px;">é€‚ç”¨äºï¼š${skill.bestFor}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="decision-section">
                    <h4>âœï¸ Prompt ä¼˜åŒ–</h4>
                    ${decision.skills.map((skill, index) => `
                        <div style="margin: 15px 0;">
                            <p style="color: #999; font-size: 13px; margin-bottom: 5px;">${skill.display_name}:</p>
                            <p style="color: #ff6b6b;">åŸå§‹è¾“å…¥ï¼š"${decision.input}"</p>
                            <p style="color: #51cf66; margin-top: 5px;">ä¼˜åŒ–åï¼š"${decision.optimizedPrompts[index]}"</p>
                        </div>
                    `).join('')}
                </div>
                <div class="decision-section">
                    <h4>âš™ï¸ å‚æ•°æ¨æ–­</h4>
                    <p>â€¢ åˆ†è¾¨ç‡ï¼š${decision.params.resolution}</p>
                    <p>â€¢ æ—¶é•¿ï¼š${decision.params.duration}</p>
                    <p>â€¢ è´¨é‡ï¼š${decision.params.quality}</p>
                </div>
            `;
            document.getElementById('decisionContent').innerHTML = content;
        }


        function saveToHistory(input, decision) {
            const historyItem = {
                input: input,
                skills: decision.skills.map(s => s.id),
                style: decision.understanding.includes('å¯çˆ±') ? 'cute' : 'professional',
                satisfied: true,
                timestamp: new Date().toISOString()
            };
            userHistory.push(historyItem);
            if (userHistory.length > 10) {
                userHistory.shift();
            }
            localStorage.setItem('seaverse_history', JSON.stringify(userHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const list = document.getElementById('historyList');
            const count = document.getElementById('historyCount');
            count.textContent = userHistory.length;
            if (userHistory.length === 0) {
                list.innerHTML = '<div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            const html = userHistory.slice().reverse().map(item => `
                <div class="history-item">
                    <span class="status">${item.satisfied ? 'âœ…' : 'âŒ'}</span>
                    <span>${item.input}</span>
                    <span style="margin-left: auto; font-size: 12px; color: #666;">${item.style === 'cute' ? 'å¯çˆ±é£æ ¼' : 'ä¸“ä¸šé£æ ¼'}</span>
                </div>
            `).join('');
            list.innerHTML = html;
        }

        function loadHistory() {
            const saved = localStorage.getItem('seaverse_history');
            if (saved) {
                userHistory = JSON.parse(saved);
            }
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿ')) {
                userHistory = [];
                localStorage.removeItem('seaverse_history');
                updateHistoryDisplay();
                document.getElementById('discoverSection').classList.add('hidden');
            }
        }

        function toggleDetails() {
            const panel = document.getElementById('decisionPanel');
            panel.classList.toggle('hidden');
        }

        function giveFeedback(type) {
            if (type === 'satisfied') {
                alert('ğŸ˜Š å¤ªå¥½äº†ï¼å·²è®°å½•ä½ çš„åå¥½ï¼Œä¸‹æ¬¡ä¼šæ›´å‡†ç¡®ï¼');
            } else if (type === 'retry') {
                alert('ğŸ˜ å¥½çš„ï¼Œè®©æˆ‘é‡æ–°ç”Ÿæˆä¸€ä¸ª...');
            } else {
                alert('ğŸ”§ é«˜çº§è°ƒæ•´åŠŸèƒ½å¼€å‘ä¸­...');
            }
        }

        function checkDiscoverRecommendation() {
            if (userHistory.length >= 5) {
                const pattern = detectPattern(userHistory);
                if (pattern) {
                    showDiscoverRecommendation(pattern);
                }
            }
        }

        function detectPattern(history) {
            const recentTasks = history.slice(-5);
            const cuteCount = recentTasks.filter(t => t.style === 'cute').length;
            if (cuteCount >= 4) {
                return {
                    type: 'cute_animal',
                    message: 'ä½ å·²ç»ç”Ÿæˆäº†å¤šå¼ å¯çˆ±åŠ¨ç‰©å›¾ç‰‡',
                    suggestions: [
                        { emoji: 'ğŸ¨', title: 'ç”Ÿæˆè¡¨æƒ…åŒ…', desc: 'ç”¨åŒä¸€é£æ ¼ç”Ÿæˆå¤šä¸ªè¡¨æƒ…' },
                        { emoji: 'ğŸ“±', title: 'åˆ¶ä½œæ‰‹æœºå£çº¸', desc: 'é€‚é…ä¸åŒè®¾å¤‡å°ºå¯¸' },
                        { emoji: 'ğŸ’¾', title: 'ä¿å­˜é…ç½®', desc: 'ä¸‹æ¬¡ä¸€é”®ç”Ÿæˆ' },
                        { emoji: 'ğŸ¬', title: 'åˆ¶ä½œåŠ¨ç”»', desc: 'å°†å›¾ç‰‡è½¬ä¸ºçŸ­è§†é¢‘' }
                    ]
                };
            }
            return null;
        }

        function showDiscoverRecommendation(pattern) {
            document.getElementById('discoverSection').classList.remove('hidden');
            document.getElementById('discoverMessage').textContent = pattern.message;
            const cards = pattern.suggestions.map(sug => `
                <div class="discover-card" onclick="handleDiscoverClick('${sug.title}')">
                    <div class="discover-card-image">${sug.emoji}</div>
                    <div class="discover-card-content">
                        <div class="discover-card-title">${sug.title}</div>
                        <div class="discover-card-desc">${sug.desc}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('discoverCards').innerHTML = cards;
            setTimeout(() => {
                document.getElementById('discoverSection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        function handleDiscoverClick(title) {
            alert(`ä½ é€‰æ‹©äº†ï¼š${title}\n\nè¿™ä¸ªåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...`);
        }

        init();

        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleGenerate();
            }
        });
    </script>
</body>
</html>
